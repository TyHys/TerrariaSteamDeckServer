# TerrariaSteamDeckServer Docker Compose Configuration
# Optimized for Steam Deck deployment
# Version 10.0.0 - CLI Management via ./server.sh

services:
  terraria:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: terraria-steamdeck-server:latest
    container_name: terraria-server
    restart: unless-stopped
    hostname: terraria-server
    
    # Port mappings
    ports:
      - "${SERVER_PORT:-7777}:7777/tcp"    # Terraria game server
    
    # Persistent volumes (bind mounts to local data directory)
    volumes:
      - ../data/worlds:/terraria/worlds        # World files
      - ../data/config:/terraria/config        # Configuration files
      - ../data/logs:/terraria/logs            # Server logs
      - ../data/backups:/terraria/backups      # World backups
    
    # Environment variables
    environment:
      # Game configuration
      - WORLD_NAME=${WORLD_NAME:-world}
      - WORLD_SIZE=${WORLD_SIZE:-2}           # 1=Small, 2=Medium, 3=Large
      - WORLD_SEED=${WORLD_SEED:-}            # Optional: specific seed
      - MAX_PLAYERS=${MAX_PLAYERS:-8}
      - SERVER_PORT=7777                      # Internal port (always 7777)
      - SERVER_PASSWORD=${SERVER_PASSWORD:-}
      - MOTD=${MOTD:-Welcome to the Terraria Server!}
      - DIFFICULTY=${DIFFICULTY:-0}           # 0=Normal, 1=Expert, 2=Master, 3=Journey
      - AUTOCREATE=${AUTOCREATE:-2}           # Auto-create world size
      - SECURE=${SECURE:-1}                   # Anti-cheat
      - LANGUAGE=${LANGUAGE:-en-US}
      
      # Process management
      - RESTART_DELAY=${RESTART_DELAY:-5}
      - RESTART_DELAY_MAX=${RESTART_DELAY_MAX:-60}
      - RESTART_DELAY_MULTIPLIER=${RESTART_DELAY_MULTIPLIER:-2}
      
      # Backup configuration
      - BACKUP_ENABLED=${BACKUP_ENABLED:-true}
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-30}
      - BACKUP_RETENTION=${BACKUP_RETENTION:-48}
      - BACKUP_ON_STARTUP=${BACKUP_ON_STARTUP:-false}
      - BACKUP_COMPRESSION=${BACKUP_COMPRESSION:-gzip}
    
    # Resource limits (optimized for Steam Deck)
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 768M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Terminal access for server commands
    stdin_open: true
    tty: true
    
    # Graceful shutdown (allow world save)
    stop_grace_period: 45s
    
    # Health check using comprehensive script
    healthcheck:
      test: ["CMD", "/terraria/scripts/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 90s

# Volumes are bind-mounted directly in the service definition above
# Data is stored in ../data/ relative to this docker-compose.yml file
